stages:
  - test
  - build
  - release

variables:
  DOCKER_TLS_CERTDIR: "/certs"

services:
  - docker:19.03.12-dind

cli-test:
  image: node:latest
  stage: test
  script:
    - cd sdk
    - yarn
    - yarn build
    - yarn link
    - cd ../cli
    - yarn link @qore/sdk
    - yarn
    - yarn test
  only:
    refs:
      - merge_requests
    changes:
      - cli/**/*

client-test:
  image: node:latest
  stage: test
  script:
    - cd client
    - yarn
    - yarn test
  only:
    refs:
      - merge_requests
    changes:
      - client/**/*

release-doc:
  image: node:latest
  stage: release
  script:
    - cd doc
    - yarn global add vercel
    - vercel --token $VERCEL_TOKEN --confirm --prod
  dependencies: 
    - build-doc
  only:
    refs:
      - merge_requests
    changes:
      - doc/**/*

build-doc:
  image: docker:19.03.12
  stage: build
  script:
    - cd doc
    - sh ./build.sh
  artifacts:
    untracked: true
  only:
    refs:
      - merge_requests
    changes:
      - doc/**/*
